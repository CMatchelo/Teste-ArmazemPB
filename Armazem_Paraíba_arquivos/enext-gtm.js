define(["jquery","pubsub","ccRestClient","pageLayout/user"],function(e,t,n,r){"use strict";return{justLoggedIn:!1,sendEvent:function(e,t){var n=this,r={event:e||"pageView",userEmail:n.user().emailAddress()||""},i=Object.assign({},r,t);window.dataLayer.push(i)},onLoad:function(i){var s=r.getInstance();window.dataLayer=window.dataLayer||[],window.dataLayer.push({originalLocation:document.location.protocol+"//"+document.location.hostname+document.location.pathname+document.location.search}),function(e,t,n,r,i){e[r]=e[r]||[],e[r].push({"gtm.start":(new Date).getTime(),event:"gtm.js"});var s=t.getElementsByTagName(n)[0],o=t.createElement(n),u=r!="dataLayer"?"&l="+r:"";o.async=!0,o.src="https://www.googletagmanager.com/gtm.js?id="+i+u,s.parentNode.insertBefore(o,s)}(window,document,"script","dataLayer",i.site().extensionSiteSettings.gtmSettings.id),e.Topic(t.topicNames.PAGE_CHANGED).subscribe(function(e){i.sendEvent();switch(e.pageId){case"home":i.sendEvent("homeView");break;case"category":var t={categoryId:e.contextId};try{n.request("listProducts",{categoryId:e.contextId,limit:12},function(e){var n=[],r=e.items,n=[];for(var s=0,o=r.length;s<o;s++)n.push(r[s].id);t.shelfProductsIds=n,i.sendEvent("categoryView",t)},function(e){i.sendEvent("categoryView",t),i.sendEvent("dataLayerError"),console.log(e)})}catch(r){i.sendEvent("categoryView",t),i.sendEvent("dataLayerError"),console.log(r)}break;case"searchresults":n.request("search",{Ntt:decodeURIComponent(e.parameters.split("&")[0].replace("Ntt=","")),Nrpp:"12"},function(e){try{var t=[],n=e.resultsList.records,t=[];for(var r=0,s=n.length;r<s;r++)t.push(n[r].records[0].attributes["product.repositoryId"][0]);i.sendEvent("searchView",{shelfProductsIds:t})}catch(o){i.sendEvent("searchView"),i.sendEvent("dataLayerError"),console.log(o)}},function(e){i.sendEvent("searchView"),i.sendEvent("dataLayerError")});break;case"product":i.sendEvent("productView",{productId:e.contextId});break;case"cart":try{var s=[];for(var o=0,u=i.cart().items().length;o<u;o++){var a=i.cart().items()[o];s.push({id:a.productId,name:a.productData().childSKUs[0].displayName,price:a.productData().childSKUs[0].salePrice.toFixed(2),quantity:a.quantity(),variant:a.catRefId})}i.sendEvent("cartView",{ecommerce:{checkout:{actionField:{step:1},products:s}}})}catch(r){i.sendEvent("cartView"),i.sendEvent("dataLayerError"),console.log(r)}break;case"checkout":i.sendEvent("checkoutView");break;case"confirmation":i.sendEvent("confirmationViewDebug");break;default:i.sendEvent("genericView")}}),e.Topic(t.topicNames.ORDER_SUBMISSION_SUCCESS).subscribe(function(e){i.sendEvent("orderSubmission"),n.request("getOrder","",function(e){try{var t=[],n=[];for(var r=0,s=e.order.items.length;r<s;r++){var o=e.order.items[r];t.push({id:o.productId,name:o.displayName,price:o.price.toFixed(2),quantity:o.quantity,variant:o.catRefId}),n.push({id:o.productId,sku:o.catRefId,name:o.displayName,price:o.price.toFixed(2),quantity:o.quantity})}window.dataLayer.push({event:"confirmationView",ecommerce:{purchase:{actionField:{id:e.id,revenue:e.priceInfo.total.toFixed(2),shipping:e.priceInfo.shipping.toFixed(2)},products:t}},transactionId:e.id,transactionAffiliation:"Armazem Paraiba",transactionTotal:e.priceInfo.total.toFixed(2),transactionTax:0,transactionShipping:e.priceInfo.shipping.toFixed(2),transactionProducts:n})}catch(u){i.sendEvent("confirmationError"),console.log(u)}},function(e){window.dataLayer.push({event:"orderSubmissionFailed"})},e[0].id)}),e.Topic(t.topicNames.USER_LOGIN_SUCCESSFUL).subscribe(function(){try{i.justLoggedIn=!0}catch(e){i.sendEvent("dataLayerError"),console.log(e)}}),e.Topic(t.topicNames.USER_LOAD_CART).subscribe(function(e){try{i.justLoggedIn&&(window.dataLayer.push({event:"userLoginSuccess",user:{id:e.id,name:e.firstName+" "+e.lastName,email:e.email}}),i.justLoggedIn=!1)}catch(t){i.sendEvent("dataLayerError"),console.log(t)}}),e.Topic(t.topicNames.USER_LOGOUT_SUBMIT).subscribe(function(){try{i.justLoggedIn=!1,window.dataLayer.push({event:"userLogoutSuccess",user:{id:s.id()}})}catch(e){i.sendEvent("dataLayerError"),console.log(e)}})}}})