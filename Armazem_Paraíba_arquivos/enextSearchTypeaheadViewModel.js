define(["knockout","pubsub","ccConstants","CCi18n","navigation","jquery","ccNumber","pageLayout/product","pageLayout/site","ccRestClient","bstypeahead","bootstrap"],function(e,t,n,r,i,s,o,u,a,f){"use strict";function M(e,t,r,i,s,o,u){O=u;if(l!==null)throw new Error("Cannot instantiate more than one SearchTypeahead, use SearchTypeahead.getInstance()");x(t.symbol),x().match(/^[0-9a-zA-Z]+$/)&&x(x+" "),k=t.fractionalDigits,this.productURLRoot=r?r:c,this.searchResultPage=i?i:n.SEARCH_RESULTS_HASH,N=s==null?!1:s,T=o==null?null:o,this.initialize(e,t)}var l=null,c="/product/";n.ALLOW_HASHBANG&&(c="#!"+c);var h="ns.common:resources.",p="ns.enext_amz_header:resources.",d="--noMatchesFound--",v="close",m="showall",g=2,y=f.getStoredValue(n.LOCAL_STORAGE_USER_CONTENT_LOCALE);y!=null?y=JSON.parse(y)[0].name:y=s(":root").attr("lang");if(y=="zh_CN"||y=="zh_TW")g=1;var b=6,w=200,E=10,S,x=e.observable(null),T=e.observable(null),N=e.observable(!1),C=e.observable(!1),k,L=e.observable(!1),A=e.observable("/img/no-image.jpg"),O=null;return s.fn.typeahead.Constructor.prototype.keyup=function(e){switch(e.keyCode){case 9:case 40:case 38:case 16:case 17:case 18:break;case 13:if(!this.shown)return;C(!0),this.select();break;case 27:if(!this.shown)return;this.hide();break;default:this.lookup()}e.stopPropagation(),e.preventDefault()},s.fn.typeahead.Constructor.prototype.move=function(e){if(!this.shown)return;switch(e.keyCode){case 13:case 27:e.preventDefault();break;case 38:e.type=="keyup"&&(e.preventDefault(),this.prev());break;case 9:e.preventDefault(),e.stopPropagation();if(e.shiftKey){var t=this.$menu.find(".active").removeClass("active"),n=t.prev();if(!n.length){if(!this.shown)return;this.hide()}n.addClass("active")}else{var t=this.$menu.find(".active").removeClass("active"),r=t.next();r.length||(r.prevObject.length==0&&this.$menu.find("li").length>1?r=s(this.$menu.find("li")[0]):this.$element.next().next().focus()),r.length===0?s("#desktopSearchSubmit").focus():r.addClass("active")}break;case 40:e.type=="keydown"&&(e.preventDefault(),this.next())}e.stopPropagation()},s.fn.typeahead.Constructor.prototype.blur=function(e){this.focused=!1;if(!this.mousedover&&this.shown)return this.$menu.hide(),this},M.prototype={initialize:function(e){if(e===undefined)throw new Error("Cannot instantiate SearchTypeahead, without a selector");s(e).typeahead({source:this.typeaheadSource,minLength:g,items:b,matcher:this.typeaheadMatch,sorter:this.typeaheadSort,updater:this.typeaheadUpdater,highlighter:this.typeaheadHighlight,render:this.typeaheadRender,select:this.typeaheadSelect,hide:this.typeaheadHide,menu:"<ul id='typeaheadDropdown' class='typeahead dropdown-menu' aria-live='polite'></ul>",item:"					<li class='typeaheadProduct'> 					<a href='#' onclick = $('#typeaheadDropdown').hide()> 					<div class='x-typeahead__productItem'> 					<div class='x-typeahead__product-image'> 					<img class='typeaheadProductThumbnail img-responsive'/> 					</div> 					<div class='x-typeahead__product-info'> 					<span class='typeaheadProductName'></span> 					<div class='x-typeahead__product-info-price'> 					<div class='x-typeahead__product-info-price__from'> 					<span class='typeaheadProductFromText__from'></span> 					<span class='typeaheadProductPrice__from'></span> 					<span class='typeaheadProductSeparator__from'></span> 					</div> 					<div class='x-typeahead__product-info-price__to'> 					<span class='typeaheadProductCurrency__to'></span> 					<span class='typeaheadProductPrice__to'></span> 					</div> 					<span class='typeaheadProductPriceError'></span> 					</div> 					</div> 					</div> 					</a> 					</li>"}),s.Topic(t.topicNames.SEARCH_TYPEAHEAD_UPDATED).subscribe(this.typeaheadResults),s.Topic(t.topicNames.SEARCH_TYPEAHEAD_CANCEL).subscribe(this.typeaheadCancel.bind(this))},typeaheadUpdater:function(e){return e},typeaheadSource:function(e,n){S=this,this.render=this.options.render||this.render,this.select=this.options.select||this.select,this.hide=this.options.hide||this.hide;var r=S.query;this.searchQuery="";if(a.getInstance().noImageSrc()&&a.getInstance().noImageSrc()!=""){A(a.getInstance().noImageSrc());var i=new Image;i.onerror=function(){A("/img/no-image.jpg")},i.src=a.getInstance().noImageSrc()}this.timer&&clearTimeout(this.timer);var o=function(){S.callback=n,S.query=S.query?S.query:r,S.searchQuery=S.query,s.Topic(t.topicNames.SEARCH_TYPEAHEAD).publishWith({searchText:S.query.replace(/\*/g,"").split(" ").join("* ").concat("*"),recordsPerPage:b,recordOffSet:0},[{message:"success"}])};this.timer=setTimeout(o,w)},typeaheadResults:function(e){S&&S.focused&&!L()&&s("#typeaheadDropdown").css("display")=="none"&&(s("#alert-modal-change").text(r.t("ns.common:resources.searchDropdownOpenedText")),L(!0));if(S&&S.focused&&S.options){var t=[],n=this[0]?this[0]:[],i=this[1]?this[1]:[],o,u;s.each(i,function(e,n){if(n.records[0]){var r=n.records[0],i={};i.id=r.attributes["product.repositoryId"][0],r.attributes["product.displayName"]?i.name=r.attributes["product.displayName"][0]:i.name="",i.thumb=r.attributes["sku.listingThumbImageURL"]?r.attributes["sku.listingThumbImageURL"]:r.attributes["product.primaryLargeImageURL"]?r.attributes["product.primaryLargeImageURL"][0]:A(),i.noImageSrc='src="'+A()+'"',i.thumb=="/img/no-image.jpg"&&(i.thumb=A(),i.noImageSrc='src="/img/no-image.jpg"'),r.attributes["product.primaryImageTitle"]&&(i.primaryImageTitle=r.attributes["product.primaryImageTitle"][0]);if(i.primaryImageAltText=r.attributes["product.primaryImageAltText"])i.primaryImageAltText=r.attributes["product.primaryImageAltText"][0];i.link=r.attributes["product.route"][0],Array.isArray(r.attributes["sku.styleProperty"])&&(o=r.attributes["sku.styleProperty"][0],o&&(Array.isArray(r.attributes["sku."+o])&&(u=r.attributes["sku."+o][0]),u&&(i.link=i.link+"?variantName="+o+"&variantValue="+u))),i.price="",t.push(i)}}),s.each(n,function(e,n){if(n.id[0]===t[e].id){var r=function(e){var t,n,r,i,s,o=e.childSKUs?e.childSKUs.length:0;if(e.minActivePrice)return e.minActivePrice;t=e.salePrice||e.salePrice===0?e.salePrice:e.listPrice;if(e.childSKUs)if(o>0)for(var s in e.childSKUs){r=e.childSKUs[s],i=r.salePrice||r.salePrice===0?r.salePrice:r.listPrice,!i&&i!=0&&(i=t);if(!n&&n!=0||i<n)n=i}else n=t;return n}(n);t[e].price=r,t[e].listPrice=n.listPrice}}),t.length||t.push({id:d,name:"",price:"",thumb:"",link:""}),S.callback&&typeof S.callback=="function"&&S.callback(t)}},typeaheadCancel:function(){S=this,S.timer&&clearTimeout(S.timer)},typeaheadMatch:function(e){return!0},typeaheadSort:function(e){return e},typeaheadHighlight:function(e){return e},typeaheadRender:function(e){if(e.length===1&&e[0].id===d){var t=r.t(h+"noMatchesFound");return this.$menu.html(s("<li class='typeaheadTop' disabled>").text(t)),this}e=s(e).map(function(e,t){function n(e){var t="";e=parseFloat(e).toFixed(k).toString();if(e==="NaN"||e===""||e===null)t=O.search_priceUnavailable;else{var n=e.split(".");t=o.formatNumber(n[0],!0),k===0?t=t.substring(0,t.length-3):(t=t.substring(0,t.length-2),t+=n[1])}return t}e=s(S.options.item).attr("data-value",t.name),N?T!=null&&e.find("a").attr("href","#").on("click",function(e){return T.getProductDetails.call(T,t.id,N),e.preventDefault(),!1}):e.find("a").attr("href",i.getPathWithLocale(t.link)).on("click",function(e){var t=s(this).attr("href");return i.goTo(t),e.preventDefault(),!1}),e.find("a").attr("title",t.name),e.find("a").attr("id",t.id),e.find(".typeaheadProductThumbnail").attr("src",t.thumb),e.find(".typeaheadProductThumbnail").attr("alt",t.primaryImageAltText),e.find(".typeaheadProductThumbnail").attr("title",t.primaryImageTitle),e.find(".typeaheadProductThumbnail").attr("onError",t.noImageSrc),e.find(".typeaheadProductName").html(t.name);var r=n(t.price);if(!isNaN(parseFloat(r))){e.find(".typeaheadProductCurrency__to").text(x()),e.find(".typeaheadProductPrice__to").text(r);if(t.listPrice&&parseFloat(t.listPrice)>parseFloat(t.price)){var u=O.search_priceFrom,a=x()+" "+n(t.listPrice);e.find(".typeaheadProductFromText__from").text(u),e.find(".typeaheadProductPrice__from").text(a),e.find(".typeaheadProductSeparator__from").text(""),e.find(".typeaheadProductSeparator__from").append('<span class="typeaheadProductSeparator__from--content">|</span>'),e.find(".typeaheadProductSeparator__from--content").css("margin-left","10px"),e.find(".typeaheadProductSeparator__from--content").css("margin-right","10px")}}else e.find(".typeaheadProductPriceError").text(r);return e[0]}),e.first().addClass("firstResult");var n=r.t(h+"closeText"),u=O.search_showAllResultsText;return this.$menu.html(e),this.$menu.append(s("<li/>").attr({"class":"typeaheadAllProducts","data-value":m}).append(s("<a/>").attr({href:"#",title:"Show all results"}).text(u))),this},typeaheadSelect:function(){var e=this.$menu.find(".active"),t=e.children("a").attr("href"),r=e.children("a").attr("id");if(t&&t!==""&&t!=="#")window.location=t;else if(t&&t==="#"&&N&&T!=null&&r!=null)T.getProductDetails.call(T,r,N);else{var o=e.attr("data-value");if(o===m||!e.length){l.typeaheadCancel(),this.searchQuery=this.query;var u;C()?(u=s.trim(this.query),C(!1)):u=this.query.trim()+n.SEARCH_WILDCARD,u.length!=0&&i.goTo(l.searchResultPage+"?"+n.SEARCH_TERM_KEY+"="+encodeURIComponent(u)+"&"+n.SEARCH_RANDOM_KEY+"="+Math.floor(Math.random()*1e3)+"&"+n.SEARCH_TYPE+"="+n.SEARCH_TYPE_SIMPLE+"&"+n.PARAMETERS_TYPE+"="+n.PARAMETERS_SEARCH_QUERY)}}return this.hide()},typeaheadHide:function(){return this.$element.val()===this.searchQuery&&this.$element.val("").change(),this.$menu.hide(),this.shown=!1,L()&&s("#typeaheadDropdown").css("display")=="none"&&(s("#alert-modal-change").text(r.t("ns.common:resources.searchDropdownClosedText")),L(!1)),this}},M.performTypeAhead=function(e){this.timer&&clearTimeout(this.timer);var n=function(){s.Topic(t.topicNames.SEARCH_TYPEAHEAD).publishWith({typeaheadConfig:e},[{message:"success"}])};this.timer=setTimeout(n,w)},M.getTypeAheadDefaultQueryParams=function(){var e=new Map;return e.set("Ntk","TypeAhead"),e.set("Ntx","mode matchany"),e.set("No","0"),e.set("Nrpp","5"),e.set("typeaheadMinLength",g),e},M.getInstance=function(e,t,n,r,i,s,o){return l=null,l=new M(e,t,r,i,s,o,n),l},M})