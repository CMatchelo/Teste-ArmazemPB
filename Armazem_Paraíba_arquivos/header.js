define(["knockout","pubsub","notifications","CCi18n","ccConstants","navigation","ccLogger","jquery","ccNumber"],function(e,t,n,r,i,s,o,u,a){"use strict";return{linkList:e.observableArray(),WIDGET_ID:"header",cartVisible:e.observable(!1),ignoreBlur:e.observable(!1),onLoad:function(t){var n=!1;o.info("on header load cart contains "+t.cart().items().length),t.linkList.removeAll();for(var a in t.links())t.linkList.push(t.links()[a]);t.cartLinkText=e.computed(function(){var e,n,i,s=t.cart().currency.symbol,e=t.formatPrice(t.cart().subTotal(),t.cart().currency.fractionalDigits);return s.match(/^[0-9a-zA-Z]+$/)&&(s+=" "),i=t.ccNumber(t.cart().numberOfItems()),n=r.t("ns.common:resources.cartDropDownText",{count:t.cart().numberOfItems(),formattedCount:i,currency:s,totalPrice:e}),n},t);var f=navigator.userAgent.match(i.IPAD_STRING)!=null;f&&u(window).on("touchend",function(e){u(e.target).closest("#dropdowncart").length||(u("#dropdowncart > .content").fadeOut("slow"),u("#dropdowncart").removeClass("active")),u(e.target).closest("#languagedropdown").length||(u("#languagedropdown > .content").fadeOut("slow"),u("#languagedropdown").removeClass("active"));if(!!u(e.target).closest("#CC-megaMenu").length)return u(e.target).closest("a").next("ul").length===0?!0:!n&&u(window).width()>=i.VIEWPORT_TABLET_UPPER_WIDTH?(n=!0,!1):n&&u(e.target).closest("a").attr("href")===s.getRelativePath()?!1:!0;u("li.cc-desktop-dropdown:hover > ul.dropdown-menu").css("display","none"),n=!1})},keypressHandler:function(e,t){var n,r,s;n=this,r=u(t.target),s=t.which?t.which:t.keyCode,t.shiftKey&&s==i.KEY_CODE_TAB&&(s=i.KEY_CODE_SHIFT_TAB);switch(s){case i.KEY_CODE_TAB:r[0].id!=="CC-header-cart-total"&&(this.handleCartClosedAnnouncement(),u("#dropdowncart").removeClass("active"));break;case i.KEY_CODE_SHIFT_TAB:r[0].id==="CC-header-cart-total"&&(this.handleCartClosedAnnouncement(),u("#dropdowncart").removeClass("active"))}return!0},showDropDownCart:function(){this.cartOpenTimeout&&clearTimeout(this.cartOpenTimeout),this.cartVisible(!0),u("#CC-header-cart-total").attr("aria-label",r.t("ns.common:resources.miniCartOpenedText")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.common:resources.miniCartOpenedText")),n.emptyGrowlMessages(),this.computeDropdowncartHeight(),this["header-dropdown-minicart"].currentSection(1),this.computeMiniCartItems(),u("#dropdowncart").addClass("active"),u("#dropdowncart > .content").fadeIn("slow");var e=this;u(document).on("mouseleave","#dropdowncart",function(){e.handleCartClosedAnnouncement(),u("#dropdowncart > .content").fadeOut("slow"),u(this).removeClass("active")});var t=navigator.userAgent.match(i.IPAD_STRING)!=null;t&&u(document).on("touchend",function(t){u(t.target).closest("#dropdowncart").length||(e.handleCartClosedAnnouncement(),u("#dropdowncart > .content").fadeOut("slow"),u("#dropdowncart").removeClass("active"))})},hideDropDownCart:function(){return this.cartVisible(!1),u("#CC-header-cart-total").attr("aria-label",r.t("ns.common:resources.miniCartClosedText")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.common:resources.miniCartClosedText")),setTimeout(function(){u("#CC-header-cart-total").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle"))},1e3),u("#dropdowncart > .content").fadeOut("slow"),u("#dropdowncart").removeClass("active"),this.cartOpenTimeout&&clearTimeout(this.cartOpenTimeout),!0},toggleDropDownCart:function(){u("#dropdowncart").hasClass("active")?this.hideDropDownCart():this.showDropDownCart()},handleRemoveFromCart:function(){u.Topic(t.topicNames.CART_REMOVE).publishWith(this.cartItem.productData(),[{message:"success",commerceItemId:this.cartItem.commerceItemId,shippingGroup:this.shippingGroupRelationship}])},handlePlaceHolderRemove:function(){u.Topic(t.topicNames.PLACE_HOLDER_REMOVE).publish(this)},handleValidateCart:function(e,n){if(e.user().isUserProfileEdited())return!0;e.cart().validatePrice=!0,s.getRelativePath()==e.links().cart.route&&e.cart().skipPriceChange(!0),u.Topic(t.topicNames.LOAD_CHECKOUT).publishWith(e.cart(),[{message:"success"}])},handleDropDownCheckout:function(e,t){this.hideDropDownCart(),this.handleValidateCart(e,t)},skipToContentHandler:function(){var e,t,n=this;for(t=0;t<n.length;t++)if(n[t].type()===i.REGION_TYPE_BODY)break;t==n.length?e=u("#main .row .redBox div:first-child").attr("id"):e="region-"+n[t].name();var r="#"+e+" :focusable";r&&u(r).first().focus()},processNrParameter:function(e,t){if(e.indexOf("(")===-1)return e;var n=e.split("(")[1],r=n.split(")")[0],i=r.split(","),s="";for(var o=0;o<i.length;o++){if(i[o].indexOf("product.priceListPair")!==-1&&t==="currency-picker")continue;if(i[o].indexOf("product.language")!==-1&&t==="language-picker")continue;s===""?s=i[o]:s=s+","+i[o]}return s=e.split("(")[0]+"("+s,s=s+")"+e.split(")")[1],s},handleCartClosedAnnouncement:function(){u("#dropdowncart").hasClass("active")&&(u("#alert-modal-change").text(r.t("ns.common:resources.miniCartClosedText")),u("#CC-header-cart-total").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")),u("#CC-header-cart-empty").attr("aria-label",r.t("ns.header:resources.miniShoppingCartTitle")))}}})