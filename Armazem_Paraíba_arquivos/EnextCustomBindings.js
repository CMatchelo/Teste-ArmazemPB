define(["jquery","knockout","ccRestClient","viewModels/inventoryViewModel"],function(e,t,n,r){"use strict";var i=t.observable(null),s=function(e,t,n,r,i){var s="\\d(?=(\\d{"+(t||3)+"})+"+(e>0?"\\D":"$")+")",o=parseFloat(i).toFixed(Math.max(0,~~e));return(r?o.replace(".",r):o).replace(new RegExp(s,"g"),"$&"+(n||","))},o=function(e){if(!isNaN(e.price)){var t=e.price;if(t!==null){var n=parseInt(e.currencyObj.fractionalDigits),r=s(n,3,".",",",t);return r}return"Preço indisponível"}return"Preço indisponível"},u=function(e,t){var n=e.currencyObj.symbol,r="";return e.itemOff&&(r='<span class="x-product-price_itemoff">'+e.itemOff+"</span>"),t?(r+='<span class="x-product-price_symbol">'+n+"</span>",r+=' <span class="x-product-price_value">'+t+"</span>"):(e.nullReplace="Não disponível",r='<span class="x-product-price_null">'+e.nullReplace+"</span>"),r},a=function(e,t,n,i,s){Array.isArray(s)&&(s=s[0]);var o=new r,u;typeof e.id()=="string"?u=e.id():u=e.id()[0];var a=function(t){if(null!==t&&t.length>0){var n=t.filter(function(e){return e.availableQuantity>0});return n.length?(e.priceLoaded(!0),!0):(i.innerHTML="<span>Produto sem estoque</span>",setTimeout(function(){e.priceLoaded(!0)},300),!1)}console.log("success but error store",t)},f=function(e){return i.innerHTML="<span>Preço indisponível</span>",!1},l=o.getLocationInventoryForUserQuery({searchText:" ",noOfStoresToDisplay:999,siteId:n,catalogId:t,locationType:"store",pickUp:!0,comparator:"CO",searchableFields:["city","postalCode","name","address1","address2","address3"],productSkuIds:u+":"+u},a.bind(e),f.bind(e))};return{onLoad:function(e){t.bindingHandlers.orderInfo={update:function(e,r,i){var s=r(),o=t.unwrap(s);n.request("getOrder",{},function(e){o.data.orderInfo(e)},function(e){console.log("Error - ",e)},o.data.orderId)}},t.bindingHandlers.currencyWithoutPrefix={update:function(e,n,r){var i=t.unwrap(n()),s=o(i),u='<span class="x-product-price_value">'+s+"</span>";e.innerHTML=u}},t.bindingHandlers.currencyWithPrefix={update:function(e,n,r){var i=t.unwrap(n()),s=o(i);e.innerHTML=u(i,s)}},t.bindingHandlers.installmentsPrice={update:function(e,n,r){e.innerHTML="";var i=n(),o=t.unwrap(i);if(!o.price||!o.quantity||!o.productId||!o.categoryId){e.innerHTML="";return}var u=parseFloat(o.price),a=parseFloat(o.quantity),f=o.productId,l=o.categoryId,c=o.textOf?o.textOf:"de";if(!u){e.innerHTML="";return}var h="https://polska.nclaudino.com.br/occ/api/parcelas",p={items:[{catRefId:l,productId:f,amount:u,quantity:a}],amount:u,shipping:0};h=h+"?k="+f,p=JSON.stringify(p);var d={method:"post",body:p,contentType:"application/json",dataType:"json"};fetch(h,d).then(function(e){return e.json()}).then(function(t){var n=0,r=t.installments.filter(function(e){return e.interest==0}).slice(-1)[0],i=s(2,3,".",",",parseFloat(r.amount)),u='<span class="x-product-installment">';o.appendText&&(u+='<span class="x-product-installment__apText">'+o.appendText+"</span> "),u+='<span class="x-product-installment__divider">'+r.number+"x</span>",u+='<span class="x-product-installment__symbol"> '+c+" "+o.currencyObj.symbol+" </span>",u+='<span class="x-product-installment__price">'+i+"</span>",o.productDetails?r.interest>0?u+='<br><span class="x-product-installment__apText x-product-installment__apText2" style="font-size: 12px; color: rgba(0,0,0,0.38)">com juros no cartão de crédito</span>':u+='<br><span class="x-product-installment__apText x-product-installment__apText2" style="font-size: 12px; color: rgba(0,0,0,0.38)">sem juros no cartão de crédito</span>':r.interest>0?u+='<br><span class="x-product-installment__apText x-product-installment__apText2" style="font-size: 12px; color: rgba(0,0,0,0.38)">com juros no cartão<br>de crédito</span>':u+='<br><span class="x-product-installment__apText x-product-installment__apText2" style="font-size: 12px; color: rgba(0,0,0,0.38)">sem juros no cartão<br>de crédito</span>',u+="</span>",i&&i!==null&&i!=""?e.innerHTML=u:e.innerHTML=o.nullReplace}).catch(function(e){})}},t.bindingHandlers.inventoryInfo={update:function(e,r,i){var s=r(),o=t.unwrap(s);n.request("getInventory",{},function(){o.data.childSKUs()[0].quantity(arguments[0].stockLevel),arguments[0].availabilityStatus==1e3?(o.data.stockStatus=t.observable("IN_STOCK"),o.data.inStock=t.observable(!0)):arguments[0].availabilityStatus==1001&&(o.data.stockStatus=t.observable("OUT_OF_STOCK"),o.data.inStock=t.observable(!1)),o.data.childSKUs()[0].loaded=t.observable(!0)},function(e){console.log("Error - ",e)},o.productId)}},t.bindingHandlers.inventoryInfoV2={update:function(e,r,i){var s=r(),o=t.unwrap(s),u=o.catalogId,f=o.siteInfoId;n.request("getInventory",{},function(){o.data.childSKUs()[0].quantity?o.data.childSKUs()[0].quantity(arguments[0].stockLevel):o.data.childSKUs()[0].quantity=t.observable(arguments[0].stockLevel),arguments[0].availabilityStatus==1e3?(o.data.stockStatus=t.observable("IN_STOCK"),o.data.inStock=t.observable(!0),o.data.priceLoaded(!0)):arguments[0].availabilityStatus==1001&&(o.data.stockStatus=t.observable("OUT_OF_STOCK"),o.data.inStock=t.observable(!1),a(o.data,u,f,e,o.productId)),o.data.childSKUs()[0].loaded=t.observable(!0)},function(e){console.log("Error - ",e)},o.productId)}},t.bindingHandlers.discountPercent={update:function(e,n,r){var i=n(),s=t.unwrap(i),o=s.listPrice,u=s.salePrice;if(o&&u){var a=((o-u)/o*100).toFixed(0);if(a>0){var f='<span class="x-product-discount">';f+='<strong class="x-product-discount_percent">'+a+"%</strong>",f+='<span class="x-product-discount_text">OFF</span>',f+="</span>",e.innerHTML=f}}}},t.bindingHandlers.capitalizeName={update:function(e,n,r){var i=n(),s=t.unwrap(i),o=["Da","De","Do","Das","Dos","A","E"],u=["da","de","do","das","dos","a","e"];if(s.text){var a=s.text;a=a.toLowerCase().replace(/(?:^|\s)\S/g,function(e){return e.toUpperCase()});for(var f=o.length-1;f>=0;f--)a=a.replace(RegExp("\\b"+o[f].replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&")+"\\b","g"),u[f]);e.innerHTML=a}}},t.bindingHandlers.textWithMarkup={update:function(e,n,r,i,s){var o=n(),u=t.unwrap(o),a,f;if(i.translate)a=i;else{var l=s.$parents;for(var c=0;c<l.length;c++)if(l[c].translate){a=l[c];break}}u.text?(f=a.translate(u.text,null,!0),f=f.replace(/\*(.*?)\*/g,"<strong>$1</strong>"),f=f.replace(/_(.*?)_/g,"<u>$1</u>"),f=f.replace(/~(.*?)~/g,"<i>$1</i>"),e.innerHTML=f):e.innerHTML="[Sem texto]"}},t.bindingHandlers.breakText={update:function(e,n,r){var i=t.unwrap(n()),s=i.text,o="",u=parseInt(i.numberOfChars);u>=6&&(u-=3,o="...");var a=s.substr(0,u)+o;e.innerHTML=a}}}}})