define(["knockout","pageLayout/product","ccLogger","ccRestClient","ccConstants","pubsub","CCi18n","js/recsRequest","pageLayout/cart","ccResourceLoader!global/slick","viewModels/inventoryViewModel","ccStoreConfiguration","spinner"],function(e,t,n,r,i,s,o,u,a,f,l,c,h){"use strict";var p;return e.bindingHandlers.recsetCCLink={init:function(t,n,r,i,s){var o=e.utils.unwrapObservable(n()),u=s.$parents,a,f=o;for(var l=0;l<u.length;l++)if(u[l].recSetId){a=u[l].recSetId;break}f.route&&(f=f.route,a&&(f.indexOf("?")==-1?f+="?recset="+encodeURIComponent(a):f+="&recset="+encodeURIComponent(a)));var c=arguments;return c[1]=e.observable({route:f}),e.bindingHandlers.ccLink.init.apply(this,c)}},{currency:e.observable(),productGroups:e.observableArray(),products:e.observableArray(),spanClass:e.observable(),recommendations:e.observableArray([]),activeProdIndex:e.observable(0),numberOfRecommendationsToShow:e.observable(),checkHasPickStore:e.observable(!1),recommendationsloaded:e.observable(!1),storeConfiguration:c.getInstance(),spinnerOptions:{parent:".verticalTabs > #tabNormalViewport",posTop:"50%",posLeft:"50%"},beforeAppear:function(){var e=this;e.initialized(!0),e.activeProdIndex(0)},onLoad:function(n){n.initialized(!1),n.recommendations=e.observableArray(),n.storeConfiguration.enableSpinnerOnPageLoad=!0,n.createSpinner(".verticalTabs"),n.currency=n.site().selectedPriceListGroup().currency,n.currency.symbol!==""&&(n.currency.oldSymbol=n.currency.symbol);var o;$.Topic(s.topicNames.PAGE_CHANGED).subscribe(function(e){o=e.pageId}),$.Topic(s.topicNames.RECS_WHO_WANT_RECS).subscribe(function(e){var t=n.pages(),r=e.pageId;if(t.indexOf(r)>-1){var i={};i.id=n.id(),i.numRecs=n.numRecs(),i.restriction=n.restriction?n.restriction():"Blended",i.strategy=n.strategy?n.strategy():"Unrestricted",i.pageId=o,i.collections=n.collections&&n.collections()?n.collections().split(",").map(function(e){return e.trim()}):[],$.Topic(s.topicNames.RECS_WANT_RECS).publish(i)}});var u=function(e){var t=e.items(),n,r=t.length,i=[],s=[];while(r--)n=t[r],i.push(n.productId),s.push({productId:n.productId,quantity:n.quantity(),price:n.itemTotal()});return[i,s]},a=function(e,o,u,a){var f=function(e){if(e.length==0)return Promise.resolve([]);var t={storePriceListGroupId:n.site().selectedPriceListGroup().id,productIds:e};return new Promise(function(n,s){r.request(i.ENDPOINT_PRODUCTS_LIST_PRODUCTS,t,n,function(t){s({response:t,requestedProductIds:e})})})};f(a.map(function(e){return e.repositoryid}))["catch"](function(e){if(e.response&&e.response.status&&e.response.status.charAt(0)=="4"&&e.response.errors){var t=e.response.errors.filter(function(e){return e.errorCode==="20031"}).map(function(e){return e.moreInfo}),n=e.requestedProductIds.filter(function(e){return t.indexOf(e)<0});if(n.length<e.requestedProductIds.length)return f(n)}return Promise.reject()}).then(function(r){r.forEach(function(n){e.push({id:n.id,recSetId:u,ccProduct:new t(n)});var r={id:n.repositoryId,url:n.route,name:n.displayName,description:n.description,manufacturer:n.brand,category:null,unit_sale_price:n.listPrice};o.push(r)}),n.recommendationsloaded(!0),$.Topic(s.topicNames.RECS_RECOMMENDATIONS_CHANGED).publish(o)})["catch"](function(e){})},f=function(e){var t,r,i,s,o=[];n.recommendations.removeAll(),r=e.recs,i=e.recSetId,a(n.recommendations,o,i,r)};$.Topic(s.topicNames.RECS_HAVE_RECS).subscribe(function(e){n.recsVisitorId=e.visitorId,n.recsSessionId=e.sessionId;var t=Object.keys(e.data);t.indexOf(n.id())>-1&&f(e.data[n.id()])})},priceUnavailableText:function(){return o.t("ns.enext_recommendations:resources.priceUnavailable")},slider:function(e,t){setTimeout(function(){var e='[id*="'+t.widgetId()+"-"+t.id()+'"] .carousel-inner',n='[id*="'+t.widgetId()+"-"+t.id()+'"]',r=parseInt(t.slidesToShowLg()),i=parseInt(t.slidesToShowMd()),s=parseInt(t.slidesToShowXs()),o=parseInt(t.slidesToScrollLg()),u=parseInt(t.slidesToScrollMd()),a=parseInt(t.slidesToScrollXs());try{$(e).css("padding",0).slick({autoplay:!0,prevArrow:'<button type="button" class="slick-prev"><svg class="slick-arrow__icon slick-arrow__icon--prev"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="file/general/icons.svg#seta4"></use></svg></button>',nextArrow:'<button type="button" class="slick-next"><svg class="slick-arrow__icon slick-arrow__icon--next"><use xmlns:xlink="http://www.w3.org/1999/xlink" xlink:href="file/general/icons.svg#seta1"></use></svg></button>',slidesToShow:r,slidesToScroll:o,centerPadding:"30px",dots:!0,responsive:[{breakpoint:1200,settings:{slidesToShow:i,slidesToScroll:u}},{breakpoint:600,settings:{slidesToShow:s,slidesToScroll:a}}],lazyLoad:"progressive"})}catch(f){}finally{t.destroySpinner(n)}},150)},createSpinner:function(e){h.create({parent:e,posTop:"50%",posLeft:"50%"})},destroySpinner:function(e){h.destroy(null,e)}}})