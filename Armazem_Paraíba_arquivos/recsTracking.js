define(["pubsub","ccLogger","ccRestClient","ccConstants","pageViewTracker","js/recsRequest","js/gdprConsent","pageLayout/cart","pageLayout/search","storageApi","swmRestClient","promise"],function(e,t,n,r,i,s,o,u,a,f,l){"use strict";function k(e){var t=e.items(),n,r=t.length,i=[];while(r--)n=t[r],i.push(n.productId);return i}function L(e){var t=e.items(),n,r=t.length,i=[],s=e.total();while(r--)n=t[r],i.push({productId:n.productId,quantity:n.quantity(),price:n.itemTotal()});return[i,s]}function A(e){var e=e||_(),t=u.singleInstance;t.items().length>0?e.addResource("cart",{cart:{productIds:k(t),pricelistGroupId:t.cartPriceListGroupId(),currencyCode:t.currencyCode(),totalPrice:t.total()}}):e.addResource("cart",{cart:{productIds:k(t)}})}function O(e){var t={},n=e.pageId,r=e.contextId;return n=="product"?t.productId=r:n=="home"||n=="search"||n=="cart",t}function M(){return S.site().tenantId}function _(){return E||(E=new s.RESTRequest(B)),E}function D(e,t){return e?(t&&(o.hasP13nCookieConsent(S.site())?(R(e),c.setItem(e,t)):(c.removeItem(e),c.setSessionItem(e,t)),w[e]=t),w[e]||c.getSessionItem(e)||c.getItem(e)):null}function P(e){return D(h,e)}function H(e){return D(p,e)}function B(e){var t=S.recsHostPortPath+"/"+e+"/3.0/json/"+M()+(P()?"/"+P():"")+(H()?"?sessionId="+H():"");return t}function j(e){e&&(e.visitorId&&P(e.visitorId),e.sessionId&&H(e.sessionId))}function F(t){var n={data:t,visitorId:P(),sessionId:H()};$.Topic(e.topicNames.RECS_HAVE_RECS).publish(n)}function I(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),n=t.exec(location.search);return n===null?"":decodeURIComponent(n[1].replace(/\+/g," "))}function q(e,t){return e=e||"",String.prototype.startsWith?e.startsWith(t):t.length>e.length?!1:e.substring(0,t.length)===t}function R(e){c.removeSessionItem(e),c.hasCookiesSupport()&&c.readFromCookies(e)!==null&&c.saveToCookies(e,"",-1)}function U(e){c.sessionStorage&&c.sessionStorage.removeItem(e)}function z(e,t){var n={"Top Sellers":"topSellers","Browsed Together":"topCobrowses","Purchased Together":"topCobuys","Most Recently Viewed":"mostRecentlyViewed","In Brand":"inBrand","In Collection":"inCategory"},r=[];return e=="Top Sellers"&&t=="In Brand"?r.push("topSellersInBrand"):e=="Top Sellers"&&t=="In Collection"?r.push("topSellersInCategory"):(n[e]&&r.push(n[e]),n[t]&&r.push(n[t])),r}function W(e){if(!S.recsHostPortPath)return;if(!M())return;var t=_();n.profileId&&t.addParam({customerId:n.profileId}),o.hasP13nCookieConsent(S.site())||t.addParam({gdpr:!0});var s=S.locale();s&&T!==s&&(T=s,t.addParam({locale:T}));var u=n.getStoredValue(r.LOCAL_STORAGE_SITE_ID);u&&N!==u&&(N=u,t.addParam({ccSiteId:N}));var a=i.getVisitorId();a&&C!==a&&(C=a,t.addParam({ccVisitorId:C})),S.localWishlists&&Object.getOwnPropertyNames(S.localWishlists).length!=0&&t.addResource("wishlists",{wishlists:S.localWishlists}),S.slots!=null&&S.slots!=undefined&&Object.getOwnPropertyNames(S.slots).length!=0&&t.addResource("recommendations",{slots:S.slots}),t.addCallback(F,"slots");var f={url:document.location.href};x&&(f.referrer=x,x=undefined);if(e.pageId==="product"){f.productId=e.contextId;var l=I("recset");l&&t.addResource("clickThru",{click:{recSetId:l,productId:e.contextId}})}S.categoryPath&&(f.category=S.categoryPath),S.pageTitle&&(f.pageTitle=S.pageTitle),S.catalogId&&(f.storeId=S.catalogId,f.excludeDefaultStore=!0);var h=S.site().selectedPriceListGroup(),p=c.getSessionItem(d),g=h.repositoryId;p!==g&&(g!=null&&g!=undefined?(c.setSessionItem(d,g),f.pricelistGroupId=g):R(d));var y=c.getSessionItem(v),b=h.currency.currencyCode;y!==b&&(b!=null&&b!=undefined?(c.setSessionItem(v,b),f.currencyCode=b):R(v)),S.searchText&&(f.searchText=S.searchText,S.searchText=""),t.addResource("view",{view:f});var w=c.getSessionItem(m);w&&(t.addResource("checkout",{checkout:JSON.parse(w)}),R(m)),X(t)}function X(e){var e=e||_();if(!S.recsHostPortPath)return;if(!M())return;e.addCallback(j,"tracking"),e.send(),E=undefined}function V(e){var t=e.items,n=[];if(t&&t.length>0){var r=0;for(r=0;r<t.length;r++)n.push(t[r].productProductId)}return n}function J(){var e=function(e){var t,n=[],r=e.items,i=0,s={};for(i=0;i<r.length;i++)t=r[i].spaceId,n=V(r[i].products),n.length>0&&(s[t]=n);Object.getOwnPropertyNames(s).length!=0&&(S.localWishlists=s)},t=function(e){};l.init(S.site().tenantId,S.isPreview(),S.locale()),l.request("GET","/swm/rs/v1/sites/{siteid}/spaces?expand=products","",e,t,{})}function K(e,t){e&&t&&(S.localWishlists||(S.localWishlists={}),S.localWishlists.hasOwnProperty(e)||(S.localWishlists[e]=[]),S.localWishlists[e].push(t))}function Q(e){e&&(S.searchText=e)}function G(e,t){if(typeof e=="object"&&!Array.isArray(e)&&e.hasOwnProperty("searchEventSummary")){var n=e.searchEventSummary;if(n){var r=_();r.addResource("search",{search:n}),X(r)}}}function Y(e){Q(a.getInstance().searchText)}function Z(e){Q(this.searchText)}function et(e){G(this,e)}function tt(e){var t=L(u.singleInstance),n=_();n.addResource("checkout",{checkout:{products:t[0],totalPrice:t[1],pricelistGroupId:u.singleInstance.cartPriceListGroupId(),currencyCode:u.singleInstance.currencyCode()}}),X(n)}function nt(e){var t=L(u.singleInstance);if(t[1]>0){var n={products:t[0],totalPrice:t[1],pricelistGroupId:u.singleInstance.cartPriceListGroupId(),currencyCode:u.singleInstance.currencyCode()};c.setSessionItem(m,JSON.stringify(n))}}function rt(e){return e.reduce(function(e,t){return e.indexOf(t)<0&&e.push(t),e},[])}function it(e){var t=_();A(t),X(t)}function st(e){var t=e.id,n=e.numRecs,r=e.strategy,i=e.restriction,s=undefined;if(S.slots==undefined||S.slots==null)S.slots={};S.slots[t]={},S.slots[t].numRecs=n,s=z(r,i),S.slots[t].rule=s,S.slots[t].dataItems=["repositoryid"],S.excludeList.length>0&&(S.slots[t].exclude=S.excludeList);if(!!e.customParams){var o=Object.keys(e.customParams);for(var u=0;u<o.length;u++)S.slots[t][o[u]]=e.customParams[o[u]]}S.extraData||(S.extraData={}),S.extraData[t]||(S.extraData[t]={}),e.collections&&(S.extraData[t].collectionIds=rt(e.collections.filter(function(e){return!!e})))}function ot(e){J()}function ut(e){var t;S&&S.product&&S.product()&&(t=S.product().id());var n=e.spaceId;n&&t&&K(n,t)}function at(){$.Topic(e.topicNames.SEARCH_CREATE).subscribe(Y),$.Topic(e.topicNames.SEARCH_TYPEAHEAD).subscribe(Z),$.Topic(e.topicNames.SEARCH_RESULTS_UPDATED).subscribe(et),$.Topic(e.topicNames.SEARCH_RESULTS_FOR_CATEGORY_UPDATED).subscribe(et),$.Topic(e.topicNames.ORDER_COMPLETED).subscribe(tt),$.Topic(e.topicNames.PAYULATAM_WEB_CHECKOUT).subscribe(nt),$.Topic(e.topicNames.CART_UPDATED).subscribe(it),$.Topic(e.topicNames.USER_LOGIN_SUCCESSFUL).subscribe(ot),$.Topic(e.topicNames.SOCIAL_SPACE_ADD_SUCCESS).subscribe(ut),$.Topic(e.topicNames.RECS_WANT_RECS).subscribe(st)}function ft(e,t,r,i,s,o,u,a){return new Promise(function(f,l){n.request(e,t,f,l,r,i,s,o,u,a)})}function lt(e,t){if(e.length==0)return Promise.resolve([]);var n={categoryIds:e,multipleCategoryPaths:!0};return t&&(n.fields=t),S.catalogId&&(n.catalogId=S.catalogId),ft(r.ENDPOINT_LIST_COLLECTIONS,n).catch(function(n){var i=e.map(function(e){var n={categoryIds:e,multipleCategoryPaths:!0};return t&&(n.fields=t),S.catalogId&&(n.catalogId=S.catalogId),ft(r.ENDPOINT_LIST_COLLECTIONS,n).then(function(e){return e[0]}).catch(function(e){})});return Promise.all(i).then(function(e){return e.filter(function(e){return!!e})})})}function ct(e,t){var n=[];if(Array.isArray(e)&&e.length>0){n=e,t||(t=S.catalogId);if(t){var r=t+b;n=e.filter(function(e){return q(e,r)}).map(function(e){return ht(e,t)})}}return n}function ht(e,t){var n=e;if(e&&t){var r=t+b;q(e,r)&&(n=e.substring(r.length,e.length))}return n}function pt(){return S.recsHostPortPath?Promise.resolve(S.recsHostPortPath):ft(r.ENDPOINT_MERCHANT_GET_EXTERNALDATA,null,r.EXTERNALDATA_PRODUCTION_RECS).then(function(e){var t=e.serviceData.host,n=e.serviceData.port,r=e.serviceData.path,i="";n&&n!==null&&n!==""&&n!=="0"&&(i=":"+n);if(t&&r)return S.recsHostPortPath="//"+t+i+"/"+r,S.recsHostPortPath;throw Error("Failed to get Recs hostname.")})}function dt(e){S=e,at(),S.user().loggedIn()&&J()}function vt(n){S.pageTitle=document.title,S.catalogId=S.user().catalogId(),S.slots=undefined,S.categoryPath=undefined,S.extraData=undefined,S.excludeList=[];if(S&&S.product&&S.product()&&S.product().relatedProducts){var r=S.product().relatedProducts,i;for(i=0;i<r.length;i++)S.excludeList.push(r[i].id)}var s={};s.pageId=n.pageId,$.Topic(e.topicNames.RECS_WHO_WANT_RECS).publish(s),pt().then(function(e){var t=[];return n.pageId=="category"&&t.push(n.contextId),S.extraData&&(t=t.concat(Object.keys(S.extraData).reduce(function(e,t){return S.extraData[t].collectionIds&&(e=e.concat(S.extraData[t].collectionIds)),e},[]))),t=rt(t),lt(t,[g,y])}).then(function(e){return e.reduce(function(e,t){return e[t.repositoryId]=t,e},{})},function(e){return t.warn("[recsTracking] Error while getting multiCatalogCategoryIdPaths: ",e),{}}).then(function(e){if(Object.keys(e).length>0){if(n.pageId=="category"&&e[n.contextId]){var t=e[n.contextId].multiCatalogCategoryIdPaths;if(Array.isArray(t)&&t.length>0){var r=ct(t,S.catalogId);r.length>0&&(S.categoryPath=r[0])}}if(S.extraData){var i=Object.keys(S.extraData);for(var s=0;s<i.length;s++)if(S.extraData[i[s]]&&S.extraData[i[s]].collectionIds){var o=S.extraData[i[s]].collectionIds.reduce(function(t,n){if(e[n]&&e[n].multiCatalogCategoryIdPaths){var r=ct(e[n].multiCatalogCategoryIdPaths,S.catalogId);t=t.concat(r)}return t},[]);S.slots&&S.slots[i[s]]&&(S.slots[i[s]].categories=o)}}}}).then(function(){W(n)}).catch(function(e){t.warn("[recsTracking] Error while retrieving recommendations: ",e)})}var c=f.getInstance(),h="occsRecVisitorId",p="occsRecSessionId",d="occsRecPricelistGroupId",v="occsRecCurrencyCode",m="occsRecPayUCheckoutInfo",g="repositoryId",y="multiCatalogCategoryIdPaths",b=":",w={},E,S,x=document.referrer,T,N,C;return{onLoad:dt,beforeAppear:vt}})